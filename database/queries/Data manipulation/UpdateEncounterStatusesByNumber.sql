BEGIN TRANSACTION;

-- Replace these values with your encounter numbers
DECLARE @EncounterNumbers TABLE (EncounterNumber varchar(50));
INSERT INTO @EncounterNumbers (EncounterNumber) VALUES
    ('T1671111242642',
'T1671111246953',
'T1671111242565',
'T1671111242652',
'T1671111243160',
'T1671111246986',
'T1671111243976',
'T1671111246956',
'T1671111242575',
'T1671111242653',
'T1671112247081',
'T1671111246987',
'T1671111243845',
'T1671111242586',
'T1671111242662',
'T1671111243181',
'T1671111243863',
'T1671111246959',
'T1671111246988',
'T1671111243970',
'T1671111243587',
'T1671111243849',
'T1671111243987',
'T1671111246960',
'T1671111242587',
'T1671111242669',
'T1671111243203',
'T1671111246989',
'T1671111243595',
'T1671111243854',
'T1671111244001',
'T1671111246962',
'T1671111242590',
'T1671111242672',
'T1671111243606',
'T1671111243873',
'T1671111244026',
'T1671111246965',
'T1671112247073',
'T1671111242673',
'T1671111243215',
'T1671111246991',
'T1671111242603',
'T1671111243616',
'T1671111246966',
'T1671111242607',
'T1671111243221',
'T1671111244048',
'T1671111243885',
'T1671111246985',
'T1671111244064',
'T1671111242679',
'T1671111244100',
'T1671112247076',
'T1671111242612',
'T1671111242682',
'T1671111243229',
'T1671111242625',
'T1671111246992',
'T1670207255567',
'T1670207256163',
'T1670207256008',
'T1670207254649',
'T1670207254773',
'T1670207256956',
'T1670207254867',
'T1670207255579',
'T1670207254658',
'T1670207254779',
'T1670207254880',
'T1670207256973',
'T1670207256666',
'T1670207256989',
'T1670207255611',
'T1670207256048',
'T1670207256320',
'T1670207256466',
'T1670207254670',
'T1670207254787',
'T1670207255625',
'T1670207254884',
'T1670207254683',
'T1670207254794',
'T1670207254899',
'T1670207254689',
'T1670207257003',
'T1670207256069',
'T1670207257014',
'T1670207254803',
'T1670207254905',
'T1670207256077',
'T1670207254706',
'T1670207254918',
'T1670207257028',
'T1670207256831',
'T1670207256368',
'T1670207254724',
'T1670207254814',
'T1670207255662',
'T1670207257038',
'T1670207256848',
'T1670207254819',
'T1670207254925',
'T1670207254736',
'T1670207254747',
'T1670207254933',
'T1670207257048',
'T1670207256854',
'T1670207254749',
'T1670207256119',
'T1670207256862',
'T1670207257057',
'T1670207254761',
'T1670207254942',
'T1670417259746',
'T1670417259753',
'T1670417259685',
'T1670417259659',
'T1670417250099',
'T1670417257140',
'T1670417256756',
'T1670417257143',
'T1670417256514',
'T1670417250136',
'T1670417256604',
'T1670417257137',
'T1670417257151',
'T1670417259698',
'T1670417256546',
'T1670417256613',
'T1670417257157',
'T1670417256551',
'T1670417256644',
'T1670417256771',
'T1670417256776',
'T1670417257168',
'T1670417256647',
'T1670417256781',
'T1670417256816',
'T1670417256651',
'T1670417259770',
'T1670417259713',
'T1670417256560',
'T1670417256653',
'T1670417257174',
'T1670417256656',
'T1670417256662',
'T1670417257202',
'T1670417256842',
'T1670417250240',
'T1670417257182',
'T1670417256678',
'T1670417250259',
'T1670417256853') 

-- Update encounter status to 31
UPDATE es
SET es.EncounterStatusId = 31
FROM dbo.EncounterStudents es
JOIN dbo.Encounters e ON es.EncounterId = e.Id
WHERE e.EncounterNumber IN (SELECT EncounterNumber FROM @EncounterNumbers);

-- Insert new status history entries (only if most recent status isn't already 31)
INSERT INTO dbo.EncounterStudentStatuses (EncounterStudentId, EncounterStatusId)
SELECT DISTINCT es.Id, 31
FROM dbo.EncounterStudents es
JOIN dbo.Encounters e ON es.EncounterId = e.Id
WHERE e.EncounterNumber IN (SELECT EncounterNumber FROM @EncounterNumbers)
AND NOT EXISTS (
    SELECT 1 
    FROM dbo.EncounterStudentStatuses ess 
    WHERE ess.EncounterStudentId = es.Id 
    AND ess.EncounterStatusId = 31
    AND ess.Id = (
        SELECT TOP 1 ess2.Id
        FROM dbo.EncounterStudentStatuses ess2
        WHERE ess2.EncounterStudentId = es.Id
        ORDER BY ess2.Id DESC
    )
);

COMMIT TRANSACTION; 